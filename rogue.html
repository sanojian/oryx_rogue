<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Oryx Rogue</title>
	<script type="text/javascript" src="./includes/crafty.js"></script>
	<script type="text/javascript" src="./includes/raphael2.js"></script>
	<script type="text/javascript" src="./includes/jQuery.js"></script>
	<!--link href='//fonts.googleapis.com/css?family=Gorditas' rel='stylesheet' type='text/css'-->
	<style>
		body, html { margin:0; padding: 0; overflow:hidden; font-family:Arial; font-size:20px }
		#cr-stage { border:2px solid black; margin:5px auto; color:white }
	</style>
	
	<script language="javascript">
"use strict";


var RENDERING_MODE = 'Canvas';
var GAME_FONT = '16pt "Arial"';//"Gorditas", cursive';
var VIEW_WIDTH = 1024;
var VIEW_HEIGHT = 600;
var TILE_WIDTH = 32;
var TILE_HEIGHT = 48;

var g_game = {};

var MAP = [
	'0000000x00000000',
	'0000000xxxxx0000',
	'00000000000x0000',
	'0000000x000x0000',
	'0000000x000x0000',
	'0000000xxxxx0000',
	'0000000000000000'
];

window.addEventListener("load", function(event) {

	Crafty.init(VIEW_WIDTH, VIEW_HEIGHT);
	
	var pos = $('#cr-stage').offset();
	$('#imgwizardBox').css({ top: pos.top,// + $('#cr-stage').height() - $('#imgwizardBox').height(), 
							left: pos.left });
	$('#imgfighterBox').css({ top: pos.top,// + $('#cr-stage').height() - $('#imgfighterBox').height(), 
							left: pos.left + $('#cr-stage').width() - $('#imgfighterBox').width() });

	doCraftyInitialization();
							
});

function centerOnPlayers() {
	try {
		var newX = Math.floor((g_game.fighter.locX + g_game.wizard.locX)/2);
		var newY = Math.floor((g_game.fighter.locY + g_game.wizard.locY)/2);
		Crafty.viewport.x = VIEW_WIDTH/2 - newX * TILE_WIDTH;
		Crafty.viewport.y = VIEW_HEIGHT/2 - newY * TILE_HEIGHT;
	} catch(ex) {;}
}

function doCraftyInitialization() {

	Crafty.c('Mob', {
		locX: 0,
		locY: 0,
		health: 2,
		maxHealth: 10,
		mana: 2,
		maxMana: 4,
		xpVal: 1,

		Mob: function(x, y, type) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, ' + type.toLowerCase())
				.attr( { x: x * TILE_WIDTH, y: y * TILE_HEIGHT, z: 100 } )
				.collision()
			
			this.locX = x;
			this.locY = y;
			
			return this;
		},
		moveMob: function(movement) {
			this.locX += movement.x;
			this.locY += movement.y;
			this.attr({ x: this.locX * TILE_WIDTH, y: this.locY * TILE_HEIGHT });
			var walls = this.hit('solid');
			if (walls) {
				this.moveMob({ x: 0- movement.x, y: 0 - movement.y});
			}
		},
		takeDamage: function(amt, from) {

			Crafty.e('DamageText')
				.DamageText(this.locX, this.locY, amt);
			
			this.health = Math.max(0, this.health - amt);
			if (this.health <= 0) {
				this.destroy();
				from.addXP(this.xpVal);
			}
		}
	});

	Crafty.c('DamageText', {
	
		DamageText: function(x, y, amt) {
			this.requires('2D, ' + RENDERING_MODE + ', Text, Tween')
				.attr({ w: 20, h: 20, x: x*TILE_WIDTH, y: y*TILE_HEIGHT, z: 100 })
				.textColor('#BE2633', 1)
				.text((amt > 0 ? '-' : '') + amt)
				.textFont({ size: "16px", weight: 'bold' })
				.tween({ y: y*TILE_HEIGHT - 48 }, 25)
				.bind('TweenEnd', function() {
					this.destroy();
				});
			return this;
		}
	
	});
	
	Crafty.c('Creature', {
	
		Creature: function(x, y, type) {
			this.requires('Mob')
				.Mob(x, y, type)
		
			return this;
		}
	});
 	
	Crafty.c('Player', {
		level: 1,
		xp: 0,
		
		Player: function(x, y, type, controls) {
			this.requires('Keyboard, Mob')
				.bind('KeyDown', function(evt) {
					var movement = {x: 0, y: 0};
					if (evt.key == Crafty.keys[controls.charAt(1)]) {
						movement.x = -1;
					}
					else if (evt.key == Crafty.keys[controls.charAt(3)]) {
						movement.x = 1;
					}
					else if (evt.key == Crafty.keys[controls.charAt(0)]) {
						movement.y = -1;
					}
					else if (evt.key == Crafty.keys[controls.charAt(2)]) {
						movement.y = 1;
					}
					else {
						return;
					}
					this.performMove(movement);
				}).bind('Move', function() {
					centerOnPlayers();
				}).bind('EnterFrame', function(frameObj) {
					if (frameObj.frame % 20 == 0) {
						this.health = Math.min(this.maxHealth, this.health + 1);
						this.mana = Math.min(this.maxMana, this.mana + 1);
						this.showHealth(type);
					}
				
				}).Mob(x, y, type)
				
				//this.playerType = type;
				if (type == 'fighter') {
					this.maxMana = 0;
				}
				else {
					this.maxMana = 16;
				}
				
				// meters
				this.posCharBox = $('#img' + type + 'Box').offset();
				this.$healthBar = $('#div' + type + 'Health');
				this.$manaBar = $('#div' + type + 'Mana');
				this.$xpBar = $('#div' + type + 'XP');
				this.$txtLevel = $('#div' + type + 'LevelText');
				this.$txtLevel.css({ left: this.posCharBox.left + 28*3, top: this.posCharBox.top + 37*3 });
				if (type == 'wizard') {
					this.$spellProgress = $('#divwizardSpellProgress');
				}
				
			return this;
		},
		showHealth: function() {
			var height = Math.floor(30 * this.health/this.maxHealth);
			this.$healthBar.css({ height: height, left: this.posCharBox.left + 39*3, top: this.posCharBox.top + 32*3 + 30 - height });
			height = this.maxMana == 0 ? '0' : Math.floor(42 * this.mana/this.maxMana);
			this.$manaBar.css({ height: height, left: this.posCharBox.left + 67*3, top: this.posCharBox.top + 31*3 + 42 - height });

			var divisor = 0;
			for (var i=0;i<this.level;i++) {
				divisor += Math.pow(2, 2+i);
			}
			var subtract = 0;
			for (var i=0;i<this.level-1;i++) {
				subtract += Math.pow(2, 2+i);
			}
			var width = Math.floor(60 * (this.xp - subtract)/(divisor - subtract));
			this.$xpBar.css({ width: width, left: this.posCharBox.left + 3*3, top: this.posCharBox.top + 40*3 });
			this.$txtLevel.text(this.level);
			/*if (this.$spellProgress) {
				width = Math.floor(48 * this.mana/4);
				if (this.mana > 4 && this.mana <= 12) {
					width = 48 + Math.floor(48 * (this.mana-4)/8);
				}
				else if (this.mana > 12 && this.mana <= 28) {
					width = 48*2 + Math.floor(48 * (this.mana-8)/16);
				}
				this.$spellProgress.css({ left: this.posCharBox.left, top: this.posCharBox.top + 48*3, width: width });
			}*/
		
		},
		addXP: function(amt) {
			this.xp += amt;
			var level = 1;
			if (this.xp >= 4 + 8 + 16 + 32 + 64 + 128 + 256 + 512 + 1024 + 2048)
				level = 11;
			else if (this.xp >= 4 + 8 + 16 + 32 + 64 + 128 + 256 + 512 + 1024)
				level = 10;
			else if (this.xp >= 4 + 8 + 16 + 32 + 64 + 128 + 256 + 512)
				level = 9;
			else if (this.xp >= 4 + 8 + 16 + 32 + 64 + 128 + 256)
				level = 8;
			else if (this.xp >= 4 + 8 + 16 + 32 + 64 + 128)
				level = 7;
			else if (this.xp >= 4 + 8 + 16 + 32 + 64)
				level = 6;
			else if (this.xp >= 4 + 8 + 16 + 32)
				level = 5;
			else if (this.xp >= 4 + 8 + 16)
				level = 4;
			else if (this.xp >= 4 + 8)
				level = 3;
			else if (this.xp >= 4)
				level = 2;
			
			if (this.level != level) {
				// ding!
			}
			this.level = level;
			this.showHealth();
		}
	});
	
	Crafty.c('Wizard', {
		bCasting: false,
	
		Wizard: function(x, y, controls) {
			this.requires('Player')
				.bind('KeyDown', function(evt) {
					if (evt.key == Crafty.keys['1'] && this.mana >= 4) {
						this.bCasting = true;
						this.mana -= 4;
						this.spell = 'Bolt';
						this.showHealth('wizard');
					}
					else if (evt.key == Crafty.keys['2'] && this.mana >= 8) {
						this.bCasting = true;
						this.mana -= 8;
						this.spell = 'Fireball';
						this.showHealth('wizard');
					}
				})
			
			this.Player(x, y, 'wizard', controls);
			
			return this;
		},
		performMove: function(movement) {
			if (this.bCasting) {
				Crafty.e(this.spell)
					[this.spell](this.locX, this.locY, movement, this);
				this.bCasting = false;
			
			}
			else {
				this.moveMob(movement);
			}
		}
	});

	Crafty.c('Fighter', {
	
		Fighter: function(x, y, controls) {
			this.requires('Player');
			
			this.Player(x, y, 'fighter', controls);
			
			return this;
		},
		performMove: function(movement) {
			this.moveMob(movement);
			var victims = this.hit('Creature');
			if (victims) {
				victims[0].obj.takeDamage(6, this);
				this.moveMob({ x: 0- movement.x, y: 0 - movement.y});
			}
		}
	});

	Crafty.c('Bolt', {
		speed: 10,
		range: 400,
	
		Bolt: function(x, y, direction, caster) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, magic_missle')
				.attr({ x: x*TILE_WIDTH, y: y*TILE_HEIGHT, z: 100})
				.bind('EnterFrame', function(frameObj) {
					this.attr({ x: this.x + direction.x*this.speed, y: this.y + direction.y*this.speed });
					this.range -= this.speed;
					if (this.range <= 0) {
						this.destroy();
					}
					else if (this.hit('solid')) {
						this.destroy();
					}
					else if (this.hit('Creature')) {
						var creatures = this.hit('Creature');
						for (var i=0;i<creatures.length;i++) {
							var xp = creatures[i].obj.takeDamage(3, this.caster);
						}
						this.destroy();
					}
				}).collision()
				
			this.caster = caster;
				
			return this;
		}
	});

	Crafty.c('Fireball', {
		speed: 8,
		range: 400,
	
		Fireball: function(x, y, direction, caster) {
			this.requires('2D, ' + RENDERING_MODE + ', Collision, fireball')
				.attr({ x: x*TILE_WIDTH, y: y*TILE_HEIGHT, z: 100})
				.bind('EnterFrame', function(frameObj) {
					this.attr({ x: this.x + direction.x*this.speed, y: this.y + direction.y*this.speed });
					this.range -= this.speed;
					if (this.range <= 0) {
						this.destroy();
					}
					else if (this.hit('solid')) {
						this.destroy();
					}
					else if ((frameObj.frame % 4 == 0) && this.hit('Creature')) {
						var creatures = this.hit('Creature');
						for (var i=0;i<creatures.length;i++) {
							creatures[i].obj.takeDamage(3, this.caster);
						}
					}
				}).collision()
				
			this.caster = caster;
				
			return this;
		}
	});
	
	
	Crafty.scene("main", function () {
		Crafty.background("#1B2632");		

		g_game.fighter = Crafty.e('Fighter')
			.Fighter(2, 2, 'IJKL');

		g_game.wizard = Crafty.e('Wizard')
			.Wizard(2, 3, 'WASD');
		
		centerOnPlayers();
		
			
		for (var y=0;y<MAP.length;y++) {
			for (var x=0;x<MAP[y].length;x++) {
				var tile = MAP[y].charAt(x);
				if (tile == 'x') {
					var sprite = 'wall';
					if (MAP[y+1] && MAP[y+1][x] == 'x') {
						sprite = 'ceiling';
					}
					
					Crafty.e('2D, ' + RENDERING_MODE + ', Collision, solid, ' + sprite)
						.attr({ x: x*TILE_WIDTH, y: y*TILE_HEIGHT, z: 100})
						.collision();
				}
			}
		}
		for (var y=MAP.length;y<MAP.length + 10;y++) {
			for (var x=0;x<MAP[0].length;x++) {
				if (Math.random() < 0.2) {
					Crafty.e('Creature')
						.Creature(x, y, 'orc');
				}
			}
		}
		
	});

	Crafty.scene("loading", function () {
		Crafty.background("#000");
		try {
		Crafty.e('2D, ' + RENDERING_MODE + ', Text').attr({ w: 800, h: 20, x: VIEW_WIDTH/2 - 400, y: VIEW_HEIGHT/2-160 })
			.text("Loading...")
			//.css({ "text-align": "center", "font-family": GAME_FONT, "font-size": "44px" });
		} catch (ex) {;}
		
		Crafty.load(['./images/oryx_fighter.png', './images/oryx_wizard.png', './images/oryx_roguelike_16x24.png'], function() {
		
		
			Crafty.sprite(1, './images/oryx_fighter.png', {
				fighter: [0, 0, TILE_WIDTH, TILE_HEIGHT]
			});
			Crafty.sprite(1, './images/oryx_wizard.png', {
				wizard: [0, 0, TILE_WIDTH, TILE_HEIGHT]
			});

			Crafty.sprite(1, './images/oryx_roguelike_16x24.png', {
				magic_missle: [5*TILE_WIDTH, 8*TILE_HEIGHT, TILE_WIDTH, TILE_HEIGHT],
				fireball: [8*TILE_WIDTH, 8*TILE_HEIGHT, TILE_WIDTH, TILE_HEIGHT],
				orc: [5*TILE_WIDTH, 29*TILE_HEIGHT, TILE_WIDTH, TILE_HEIGHT]
			});

			Crafty.sprite(1, './images/tiles.png', {
				wall: [0, 1*TILE_HEIGHT, TILE_WIDTH, TILE_HEIGHT],
				ceiling: [7*TILE_WIDTH, 0, TILE_WIDTH, TILE_HEIGHT]
			});

		
			Crafty.scene("main");
			
		});
	});
	
	Crafty.scene("loading");	

}
		
	</script>
</head>
<body>

	<img id="imgwizardBox" src="./images/charbox_wizard.png" style="position: absolute;z-index: 10000;" />
	<div id="divwizardHealth" style="background: #BE2633;position: absolute;width: 33px; height: 30px;z-index: 9000"></div> 
	<div id="divwizardMana" style="background: #005784;position: absolute;width: 30px; height: 42px;z-index: 9000"></div> 
	<div id="divwizardXP" style="background: #EB8931;position: absolute;width: 30px; height: 9px;z-index: 11000"></div> 
	<div id="divwizardSpellProgress" style="background-image: url(./images/spellProgress.png);height: 48px; width: 240px;position: absolute;z-index: 11000"></div> 
	<div id="divwizardLevelText" style="position: absolute;z-index: 11000; color: #9D9D9D; text-align: center;">00</div> 
	
	<img id="imgfighterBox" src="./images/charbox_fighter.png" style="position: absolute;z-index: 10000;" />
	<div id="divfighterHealth" style="background: #BE2633;position: absolute;width: 33px; height: 30px;z-index: 9000" ></div> 
	<div id="divfighterMana" style="background: #005784;position: absolute;width: 30px; height: 42px;z-index: 9000" ></div> 
	<div id="divfighterXP" style="background: #EB8931;position: absolute;width: 30px; height: 9px;z-index: 11000"></div> 
	<div id="divfighterLevelText" style="position: absolute;z-index: 11000; color: #9D9D9D; text-align: center;">00</div> 
	

</body>
